<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="StyleSheet" href="Massively%20Interleaved%20Sprite%20Crunch-Dateien/style3.css" type="text/css"><link rel="alternate" type="application/rss+xml" title="RSS" href="http://www.linusakesson.net/rssfeed.php"><link rel="shortcut icon" href="https://www.linusakesson.net/img/fav2.png" type="image/png"><link rel="icon" href="https://www.linusakesson.net/img/fav2.png" type="image/png"><script type="text/javascript">
<!--
function captchaenter(e) {
var keynum;
if(window.event) { keynum = e.keyCode; } else { keynum = e.which; }
return keynum != 13;
}
function sitecfg() {
document.getElementById("cfgform").submit();
}
//-->
</script><title>Massively Interleaved Sprite Crunch</title></head><body><div class="outer"><div id="leftbar" class="leftbar"><div class="toc0" style="clear: both"><div style="display: block"><a href="https://www.linusakesson.net/index.php"><img style="display: inline; margin: .2em" src="Massively%20Interleaved%20Sprite%20Crunch-Dateien/linus1.png" alt="">
</a></div><div style="display: block; margin-top: .1em; margin-bottom: .3em"><a href="https://www.linusakesson.net/index.php" style="font: bold 1em sans-serif; text-decoration: none">linusakesson.net</a></div></div><div class="tocalt" id="tocalt"><a href="#" onclick="document.getElementById('tocdiv').style.display = 'block'; document.getElementById('tocalt').style.display = 'none';" style="font-size: .8em">(show&nbsp;navigation)</a></div><div class="tocdiv" id="tocdiv"><a href="#" onclick="document.getElementById('tocalt').style.display = 'block'; document.getElementById('tocdiv').style.display = 'none';" style="font-size: .8em">(hide&nbsp;navigation)</a><form id="cfgform" method="post" action="/scene/lunatico/misc.php"><div class="confbox"><input name="cmd" value="conf" type="hidden"><ul class="conf"><li><input onclick="sitecfg()" name="confswe" type="checkbox"> Swedish content</li></ul><noscript><div><input type="submit" value="Configure site" /></div></noscript></div></form><div class="tocgroup"><form method="get" action="/search.php"><div class="toc2"><h5 style="margin: 8px 0 0 0;">Site search:</h5><input name="q" style="width: auto"></div></form><table class="toc"><tbody><tr><th class="toc1">Navigation</th></tr><tr><td class="toc2"><a href="https://www.linusakesson.net/">Home&nbsp;&amp;&nbsp;news</a></td></tr><tr><td class="toc2"><a href="https://www.linusakesson.net/random.php?anticache=1522727644">Random&nbsp;page</a></td></tr><tr><td class="toc2"><a href="https://www.linusakesson.net/archive.php">All&nbsp;pages</a></td></tr></tbody></table><table class="toc"><tbody><tr><th class="toc1">Databases</th></tr><tr><td class="toc2"><a href="https://www.linusakesson.net/cookies/">Fortune&nbsp;cookies</a></td></tr><tr><td class="toc2"><a href="https://www.linusakesson.net/themes/">SID&nbsp;themes</a></td></tr></tbody></table></div><div class="tocgroup"><table class="toc"><tbody><tr><th class="toc1">Page collections</th></tr><tr><td class="toc2"><a href="https://www.linusakesson.net/blag/index.php">Blag</a></td></tr><tr><td class="toc2"><a href="https://www.linusakesson.net/music/chipmusic.php">Chip&nbsp;music</a></td></tr><tr><td class="toc2"><a href="https://www.linusakesson.net/chipophone/pages.php">Chipophone</a></td></tr><tr><td class="toc2"><a href="https://www.linusakesson.net/games/index.php">Games</a></td></tr><tr><td class="toc2"><a href="https://www.linusakesson.net/hardware/index.php">Hardware&nbsp;projects</a></td></tr><tr><td class="toc2"><a href="https://www.linusakesson.net/music/downloads.php">Music&nbsp;downloads</a></td></tr><tr><td class="toc2"><a href="https://www.linusakesson.net/programming/obfuscation.php">Obfuscated&nbsp;programming</a></td></tr><tr><td class="toc2"><a href="https://www.linusakesson.net/music/piano.php">Piano&nbsp;music</a></td></tr><tr><td class="toc2"><a href="https://www.linusakesson.net/programming/index.php">Sane&nbsp;programming</a></td></tr><tr><td class="toc2"><a href="https://www.linusakesson.net/pages/scene.php">Scene&nbsp;productions</a></td></tr><tr><td class="toc2"><a href="https://www.linusakesson.net/music/sidstuff/index.php">SID&nbsp;related&nbsp;pages</a></td></tr><tr><td class="toc2"><a href="https://www.linusakesson.net/software/index.php">Software&nbsp;downloads</a></td></tr><tr><td class="toc2"><a href="https://www.linusakesson.net/programming/underhanded/index.php">Underhanded&nbsp;code</a></td></tr><tr><td class="toc2"><a href="https://www.linusakesson.net/pages/video.php">Video&nbsp;clips</a></td></tr></tbody></table></div><div class="tocgroup"><table class="toc"><tbody><tr><th class="toc1">Featured pages</th></tr><tr><td class="toc2"><a href="https://www.linusakesson.net/scene/a-mind-is-born/index.php">A&nbsp;Mind&nbsp;Is&nbsp;Born</a></td></tr><tr><td class="toc2"><a href="https://www.linusakesson.net/music/po-2x/prehistoric.php">A&nbsp;Prehistoric&nbsp;Tale</a></td></tr><tr><td class="toc2"><a href="https://www.linusakesson.net/games/autosokoban/index.php">Autosokoban</a></td></tr><tr><td class="toc2"><a href="https://www.linusakesson.net/software/blackbird/index.php">Blackbird</a></td></tr><tr><td class="toc2"><a href="https://www.linusakesson.net/chipophone/index.php">Chipophone</a></td></tr><tr><td class="toc2"><a href="https://www.linusakesson.net/scene/craft/index.php">Craft</a></td></tr><tr><td class="toc2"><a href="https://www.linusakesson.net/cryptic/3/index.php">Cryptic&nbsp;Crossword&nbsp;#3</a></td></tr><tr><td class="toc2"><a href="https://www.linusakesson.net/music/sidstuff/dishwasher.php">Dishwasher&nbsp;Groove</a></td></tr><tr><td class="toc2"><a href="https://www.linusakesson.net/music/elements/index.php">Elements&nbsp;of&nbsp;Chip&nbsp;Music</a></td></tr><tr><td class="toc2"><a href="https://www.linusakesson.net/programming/underhanded/2015.php">Faking&nbsp;Fissile&nbsp;Material</a></td></tr><tr><td class="toc2"><a href="https://www.linusakesson.net/programming/fieldsort/index.php">Field&nbsp;Sort</a></td></tr><tr><td class="toc2"><a href="https://www.linusakesson.net/music/fratres/index.php">Fratres</a></td></tr><tr><td class="toc2"><a href="https://www.linusakesson.net/programming/gcr-decoding/index.php">GCR&nbsp;decoding&nbsp;on&nbsp;the&nbsp;fly</a></td></tr><tr><td class="toc2"><a href="https://www.linusakesson.net/music/sidstuff/glyptodont.php">Glyptodont</a></td></tr><tr><td class="toc2"><a href="https://www.linusakesson.net/music/sidstuff/hanlonfugue/index.php">Hanlon&nbsp;Fugue</a></td></tr><tr><td class="toc2"><a href="https://www.linusakesson.net/games/hardsync/index.php">Hardsync</a></td></tr><tr><td class="toc2"><a href="https://www.linusakesson.net/reviews/ifcomp2017/1.php">IFComp&nbsp;2017&nbsp;reviews&nbsp;#1</a></td></tr><tr><td class="toc2"><a href="https://www.linusakesson.net/reviews/ifcomp2017/2.php">IFComp&nbsp;2017&nbsp;reviews&nbsp;#2</a></td></tr><tr><td class="toc2"><a href="https://www.linusakesson.net/programming/kernighans-lever/index.php">Kernighan's&nbsp;lever</a></td></tr><tr><td class="toc2"><a href="https://www.linusakesson.net/games/klamrisk/index.php">Klämrisk&nbsp;Hero</a></td></tr><tr><td class="toc2"><a href="https://www.linusakesson.net/music/po-2x/ds2017.php">Live&nbsp;at&nbsp;Datastorm</a></td></tr><tr><td class="toc2"><a href="https://www.linusakesson.net/scene/lunatico/index.php">Lunatico</a></td></tr><tr><td class="toc2"><a href="https://www.linusakesson.net/music/po-2x/marblemachine.php">Marble&nbsp;Machine&nbsp;8-bit&nbsp;jam</a></td></tr><tr><td class="toc2"><a href="https://www.linusakesson.net/scene/lunatico/misc.php">MISC</a></td></tr><tr><td class="toc2"><a href="https://www.linusakesson.net/scene/parallelogram/index.php">Parallelogram</a></td></tr><tr><td class="toc2"><a href="https://www.linusakesson.net/music/po-2x/index.php">PO-2x</a></td></tr><tr><td class="toc2"><a href="https://www.linusakesson.net/programming/poems-for-bugs/index.php">Poems&nbsp;for&nbsp;bugs</a></td></tr><tr><td class="toc2"><a href="https://www.linusakesson.net/chipophone/pushingonwards.php">Pushing&nbsp;Onwards</a></td></tr><tr><td class="toc2"><a href="https://www.linusakesson.net/music/reverberations/index.php">Reverberations</a></td></tr><tr><td class="toc2"><a href="https://www.linusakesson.net/software/sidreloc/index.php">Sidreloc</a></td></tr><tr><td class="toc2"><a href="https://www.linusakesson.net/software/spindle/v2.php">Spindle&nbsp;v2</a></td></tr><tr><td class="toc2"><a href="https://www.linusakesson.net/music/nocturne/index.php">Stein's&nbsp;Nocturne</a></td></tr><tr><td class="toc2"><a href="https://www.linusakesson.net/games/stranded64/index.php">Stranded&nbsp;for&nbsp;the&nbsp;C64</a></td></tr><tr><td class="toc2"><a href="https://www.linusakesson.net/art/three-petscii-pieces/index.php">Three&nbsp;PETSCII&nbsp;pieces</a></td></tr><tr><td class="toc2"><a href="https://www.linusakesson.net/music/sidstuff/to-die-for.php">To&nbsp;Die&nbsp;For</a></td></tr><tr><td class="toc2"><a href="https://www.linusakesson.net/music/sidstuff/toyrocket.php">Toy&nbsp;Rocket</a></td></tr><tr><td class="toc2"><a href="https://www.linusakesson.net/programming/tty/index.php">TTY&nbsp;demystified</a></td></tr><tr><td class="toc2"><a href="https://www.linusakesson.net/music/variation18/index.php">Variation&nbsp;18</a></td></tr><tr><td class="toc2"><a href="https://www.linusakesson.net/art/nibbles/index.php">We&nbsp;learn&nbsp;the&nbsp;nibbles</a></td></tr><tr><td class="toc2"><a href="https://www.linusakesson.net/cryptic/2/index.php">Wings&nbsp;I've&nbsp;lost&nbsp;in&nbsp;dreams</a></td></tr><tr><td class="toc2"><a href="https://www.linusakesson.net/software/zeugma/index.php">Zeugma</a></td></tr></tbody></table></div><div class="tocgroup"><table class="toc"><tbody><tr><th class="toc1">Don't miss</th></tr><tr><td class="toc2" style="padding: 0px; text-align: left"><a href="https://www.linusakesson.net/music/sidstuff/chipful-of-love.php"><img src="Massively%20Interleaved%20Sprite%20Crunch-Dateien/124.png" alt="Page thumbnail" style="border: 1px solid #cccccc; margin: 1em"></a><br>
<a style="margin-left: 1em" href="https://www.linusakesson.net/music/sidstuff/chipful-of-love.php">A Chipful of Love For You</a></td></tr></tbody></table><table class="toc"><tbody><tr><th class="toc1">Forum</th></tr><tr><td class="toc2"><a href="https://www.linusakesson.net/forum/register.php">Register</a></td></tr><tr><td class="toc2"><a href="https://www.linusakesson.net/forum/login.php">Log&nbsp;in</a></td></tr><tr><td class="toc2"><a href="https://www.linusakesson.net/forum/chronological.php">Latest&nbsp;comments</a></td></tr></tbody></table><table class="toc"><tbody><tr><th class="toc1">Syndication</th></tr><tr><td class="toc2"><a type="application/rss+xml" href="http://www.linusakesson.net/rssfeed.php">RSS feed</a></td></tr></tbody></table><table class="toc"><tbody><tr><th class="toc1">Feedback</th></tr><tr><td class="toc2"><script type="text/javascript">
<!--
a = "@";a = a + "linusak";a = "linus" + a;a = a + "esson.net";document.write("<a href=\"mailto:");document.write(a);document.write("\">");document.write(a);document.write("</a>");//-->
</script><a href="mailto:linus@linusakesson.net">linus@linusakesson.net</a></td></tr></tbody></table></div></div></div><div class="maindiv"><div class="maindiv2"><a href="https://www.linusakesson.net/pages/scene.php"><div class="idthumb"><img title="Scene productions" alt="Scene productions" src="Massively%20Interleaved%20Sprite%20Crunch-Dateien/scenethumb2.png"></div></a><div class="searchable">
<h1>Massively Interleaved Sprite Crunch</h1>

<p><span class="blurb">This article describes the inner workings of
<i>Massively Interleaved Sprite Crunch</i> (<i>MISC</i>), a new C64 demo effect
introduced in my demo <a href="https://www.linusakesson.net/scene/lunatico/index.php">Lunatico</a>.</span></p>

<p>The effect is used in the greetings part, depicted below.</p>

<img src="Massively%20Interleaved%20Sprite%20Crunch-Dateien/misc-greetings.png">

<p>I know that most of my readers don't code for the C64. You may still want to
skim through the article, just to get a feeling of what it's like. Or you could
watch my talk <a href="https://www.linusakesson.net/programming/poems-for-bugs/index.php">Poems&nbsp;for&nbsp;Bugs</a>
for a gentler introduction to the subject.</p>

<p>The MISC effect is actually a combination of three new ways of abusing
quirks in the VIC chip. The quirks themselves have been known for a long time,
but they have never been put to use in this particular way before.</p>

<h2>Background</h2>

<p>(You can skip this part if you already know about sprites on the C64.)</p>

<p>The video interface controller (VIC chip) in the Commodore&nbsp;64 supports
<i>sprites</i>. A sprite is a small piece of graphics, 24&nbsp;x&nbsp;21 pixels
in size, that can be placed anywhere on the screen. Each pixel is either opaque
or transparent. (That's a simplification; there's also a multi-colour
mode, but it's not used for this effect.) Up to eight sprites can be active at
the same time. A sprite is activated by writing the desired X&nbsp;and
Y&nbsp;coordinates, foreground colour and a pointer to the pixel data into
special memory locations—there are eight copies of these special
locations, one for each sprite—and setting the corresponding bit in the
Sprite Enable register.</p>

<p>As the video beam traces down the screen, it eventually arrives at the
rasterline just above the sprite. Here, <i>sprite DMA</i> is activated. From
this point on, the CPU is halted for a few clock cycles on every rasterline,
during which graphics data for the sprite are fetched from memory. Pixels are
fetched during the horizontal blanking period that precedes the line on which
they are emitted. On the final rasterline of the visible sprite, DMA is turned
off again.</p>

<p>Sprites may be <i>Y-expanded</i> by setting a bit in a special register.
Expansion is handled independently for each sprite. When a sprite is
Y-expanded, each line of pixel data is fetched twice. That is, the pointer to
the next row of data is only incremented on every other line. In the hardware,
this is implemented using a <i>latch</i> (or <i>flag</i>) that is toggled on
every line in Y-expanded mode. The pointer is only incremented if the latch is
currently set.</p>

<p>A quite intentional feature of the VIC chip is that sprites may be reused
several times during a single video frame. After a sprite has finished
displaying, i.e. on the rasterline just below it, you may re-initialise the
X&nbsp;and Y&nbsp;coordinates, colour, pointer to graphics etc., and in that
way reuse the sprite hardware further down on the screen. You can do this as
many times as you wish in order to put lots of movable objects on the screen.
This is known as <i>sprite multiplexing</i>. However, there's an inherent
limitation: Once a sprite has been activated, it will remain active until each
of its 21&nbsp;lines of pixels have been emitted and its DMA has been turned
off again. You can't abort a sprite after, say, 10 rasterlines.</p>

<h2>Sprite Crunch</h2>

<div style="float: right; margin: 1em; width: 217px">
<img src="Massively%20Interleaved%20Sprite%20Crunch-Dateien/misc-layout0.png">
<p class="picdesc">The traditional way of laying out sprite graphics in memory. The dark grey byte doesn't get fetched.</p>
</div>

<div style="clear: right; float: right; margin: 1em">
<img src="Massively%20Interleaved%20Sprite%20Crunch-Dateien/misc-graph.png">
</div>

<p>Sprite pixels are stored in a 63-byte data structure, organised as an array
of twenty-one chunks of three bytes each. Every three-byte chunk contains the
24&nbsp;pixels corresponding to one row of sprite graphics. This data structure
must be aligned on a 64-byte boundary in memory. The high bits of the address
of this data structure are known as the <i>sprite pointer</i>. For each sprite,
the VIC chip maintains a current 6-bit <i>sprite offset</i> corresponding to
the lower bits of the address. This offset is kept in an internal per-sprite
register called <tt>MCBASE</tt>.</p>

<p>Under normal circumstances, sprite data is fetched as follows: When the
sprite is first enabled, <tt>MCBASE</tt> is reset to zero. For each rasterline
where sprite DMA is enabled, <tt>MCBASE</tt> is first copied into another 6-bit
register called <tt>MC</tt>. While fetching the three bytes that make up a row,
<tt>MC</tt> is incremented, so that after fetching the row,
<tt>MC&nbsp;=&nbsp;MCBASE&nbsp;+&nbsp;3 (mod&nbsp;64)</tt>. Then, depending on
the current value of the Y-expand latch, <tt>MCBASE</tt> is either left alone,
or set to the current value of <tt>MC</tt>. The whole thing then repeats until
<tt>MCBASE&nbsp;=&nbsp;63</tt>.

</p><p>There is, however, a very curious way in which we can trick the VIC chip
into doing something entirely different. It was first used by <b>Pernod</b> in
the demo <a href="http://csdb.dk/release/?id=684">Rutig&nbsp;Banan</a> (1989),
and subsequently explored and described in more detail by <b>Crossbow</b> in
the demo <a href="http://csdb.dk/release/?id=2968">Krestage</a> (1997).
Crossbow named the effect <i>sprite crunch</i>, because he used it to crunch
sprites—make them shorter—in order to be able to reuse the sprite
hardware earlier. (The naming is unfortunate, in the sense that the effect may
equally well be used for making sprites taller, but we are stuck with the name.
<b>HCL</b> has suggested <i>sprite scrambling</i>, but it hasn't caught on.)</p>

<p>Krestage:</p>

<img src="Massively%20Interleaved%20Sprite%20Crunch-Dateien/misc-krestage.png">

<p>Precise timing is required for this trick. Specifically, one has to
<i>disable Y-expand at the fifteenth clock cycle of a rasterline</i>. This will
apparently flip the latch while the VIC chip is halfway through the act of
determining whether to assign the <tt>MCBASE</tt> register from <tt>MC</tt> or
from itself (i.e. leaving it at its current value). The hardware is confused by
this, and <tt>MCBASE</tt> instead receives the following very peculiar value:
<tt>((MC | MCBASE) &amp; 0x15) | ((MC &amp; MCBASE) &amp; 0x2a)</tt>. That is, the bits of
the two candidate values are alternately combined using bitwise AND and bitwise
OR.</p>

<p>This allows us to mess with the sprite offset and skip around inside the
sprite graphics, but only via a predefined set of jumps, shown in the graph to
the right. Sprite crunching is perhaps the most bizarre VIC chip bug discovered
to this day, and many programmers consider it to be too complicated to be
useful in practice.</p>

<h2>Flexible sprite height</h2>

<p>Crossbow found the shortest path from <b>start</b> to <b>end</b>, which
passes through 17&nbsp;nodes. Thus, he was able to reuse a sprite after
17&nbsp;rasterlines instead of the usual&nbsp;21, and consequently reported
this as the minimum height of a sprite. But that is only true under the
assumption that we always have to begin at <b>start</b>. If we organise our
pixels differently, we could instead treat, say, offset 0x15 as the origin,
crunch our way through the sequence 15–18–1b–1e and be back
at the origin after no more than four rasterlines. This particular sequence has
been used in several demos, including <a href="http://csdb.dk/release/?id=72550">Edge&nbsp;of&nbsp;Disgrace</a> (2008)
and my own <a href="https://www.linusakesson.net/scene/shards-of-fancy/index.php">Shards&nbsp;of&nbsp;Fancy</a>
(2013).</p>

<p><b>The first innovation</b> in MISC is the following: By studying the sprite
crunch graph, I discovered that if we start from offset <b>0x35</b>, we have as
many as eight different loops of varying length at our disposal. The lengths are 1, 13,
14, 17, 18, 19, 20 and&nbsp;21. So if we always organise our pixel data with the
top-left corner of the graphical object at offset 0x35, we can effectively
create columns of sprites of varying height.</p>

<p>In the greetings part of Lunatico, four different sprite heights are used,
corresponding to loops of length&nbsp;14, 17, 19 and&nbsp;21:</p>

<ul>
<li>35–38–3b–3e–15–18–1b–1e–21–25–28–2b–2e–31</li>
<li>35–38–3b–3e–01–05–08–0b–0f–17–1a–1d–20–23–27–2a–2d</li>
<li>35–38–3b–3e–01–04–07–0a–0d–15–18–1b–1e–21–25–28–2b–2e–31</li>
<li>35–38–3b–3e–01–05–08–0b–0e–11–14–17–1a–1d–20–23–26–29–2c–2f–32</li>
</ul>

<div style="clear: right; float: right; margin: 1em; width: 217px">
<img src="Massively%20Interleaved%20Sprite%20Crunch-Dateien/misc-layout1.png">
<p class="picdesc">The same space invader, organised in memory according
 to a crunch schedule of length&nbsp;17, starting at (and returning to) 
offset&nbsp;0x35. Dark grey bytes aren't fetched.</p>
</div>

<p>Let's refer to such sequences as <i>crunch schedules</i>.</p>

<p>The last of the schedules listed above is noteworthy enough to be referred
to as <b>the second innovation</b>. Sprites are normally 21&nbsp;lines tall, so
by crunching at just the right moment (here jumping from offset&nbsp;0x01
to&nbsp;0x05) we obtain a <i>full-height loop</i>. In fact, there are several
such loops; one could just as well crunch at offset 0x03, towards the beginning
of normal sprite display, or at offset 0x39, towards the end.</p>

<p>This second innovation isn't pivotal for the greetings part of
Lunatico, which probably would have looked just as good with a maximum sprite
height of&nbsp;20, but it ought to be a very useful technique in general.
Normally, in order to create a full-width <i>sprite carpet</i>—a large,
rectangular portion of the screen with sprites arranged back-to-back in a
grid—one must spend at least 34&nbsp;cycles for every sprite row just to
update the Y&nbsp;coordinate registers. By making use of a 21-line loop as
described above, this can be reduced to 12&nbsp;cycles. The drawback is that it
requires precise timing and won't work on badlines.</p>

<p>At this point, it may be illustrative to describe how the Lunatico greetings
part is built up. The skyline on the left side is part of a bitmap picture and
doesn't concern us here. The eight columns of letters are built up from
sprites. Each letter exists in four different versions, of heights 14, 17, 19
and&nbsp;21. The pixels have been organised with the origin at sprite offset
0x35, and the first line is always blank (this is the small gap between
letters).</p>

<p>If, say, a particular letter of height&nbsp;17 is to be displayed, the
sprite crunch trick needs to be triggered five times for that sprite, according
to the crunch schedule of length&nbsp;17: At offsets 0x01, 0x0b, 0x0f, 0x23
and&nbsp;0x2d. To clarify: Look at the graph, start at offset 0x35. Solid lines
represent the normal case of adding three to the offset, whereas dashed lines
represent triggering the glitch. Crunching at the aforementioned offsets will
bring you back to offset 0x35 in exactly 17&nbsp;steps.</p>

<p>To build up the entire video frame, the crunch schedules of every letter in
every column have to be combined somehow. If the letters weren't moving, that
computation could be performed offline (i.e. at compile time), with the result
organised as a table with one entry per rasterline. A loop of timed
code would read the precomputed values from the table and feed them into the
Y-expand hardware register.</p>

<p>But of course, as the characters wobble independently in each column, these
interleaved crunch schedules also have to move about. The C64 does not have
enough memory to keep one such precalculated table for every animation frame,
and there isn't enough time during vertical blanking to compute new tables on
the fly. Instead, we must at least partially compute the values for the
Y-expand register in realtime, during the visible portion of the display. But
this involves somehow computing the eight desired bits of the register
independently, joining them together into a byte, writing that byte into the
register at the precise moment, and finally resetting the register in
anticipation of the next rasterline. But with all sprites enabled, sprite DMA
is going to take away most of the CPU time—in fact, we only have
44&nbsp;clock cycles left per rasterline for doing all that.</p>

<p>This is where <b>the third innovation</b> enters the picture.</p>

<h2>How to represent crunch schedules</h2>

<p>The VIC chip has a feature that is rarely used in demos: <i>Collision
detection</i>. A sprite is said to collide with the background graphics (i.e.
non-sprite graphics) if the sprite emits a non-transparent pixel at the same
time as the video generator emits a foreground pixel. When this happens, a
latch is set in a special hardware register. There is one latch bit for each
sprite. Reading the register clears the latches. This is useful when
programming simple games, such as <i>Pong</i>: During vertical blanking, it is
easy to check whether the ball hit a wall during the preceding frame. (There is also
support for detecting sprite-to-sprite collisions, but that feature isn't used in the
Lunatico greetings part.)</p>

<p>But note that collision detection can be used more than once in a single video
frame. The latches are set on collisions, and cleared when reading the
register.</p>

<div style="clear: right; float: right; margin: 1em; width: 217px">
<img src="Massively%20Interleaved%20Sprite%20Crunch-Dateien/misc-layout2.png">
<p class="picdesc">The rightmost pixel in each row is repurposed to 
indicate whether a sprite crunch is due three rasterlines later. Dark 
grey bytes aren't fetched.</p>
</div>

<p>MISC hinges on the idea that we can encode the crunch schedule for a sprite
<b>in the very pixels of the sprite</b>, and read it out using collision
detection. Then, as the sprite moves around on the screen, so do the locations
on which its pixels trigger collisions. In Lunatico, each sprite column is
covered by a thin, black stripe of foreground pixels, hidden in the bitmap
displayed by the video generator. Since the background is also black, the
stripes are invisible to the eye, but they cover the rightmost pixels of each
sprite. And as a consequence, when those rightmost pixels are set, they trigger
collisions.</p>

<p>Hence, we can read the collision register at the end of each rasterline and
obtain the rightmost pixel of the current row of each of the eight sprites,
already packed into a single byte. This byte is simply copied into the Y-expand
register. The rightmost pixels of each sprite have been set up to trigger the
correct sequence of crunch operations to maintain the correct loop for the
desired sprite height. So if we were to leave the sprite pointers untouched,
this would cause each column to display a particular letter of a particular
height, repeated all the way down the screen.</p>

<p>But of course, in the actual demo effect, the sprite pointers are updated
just after each letter, diverting the graph traversal into the correct crunch
schedule for the next letter, and so on all the way down. And thus we have
reduced the problem of managing the timing of each individual sprite crunch
event (several for each letter) into the much easier problem of managing the
timing of the sprite pointer updates (one for each letter). This is what makes
the effect feasible.

</p><h2>Tribulations of timing</h2>

<p>The clean principle outlined above is complicated by a couple of
practicalities. First of all, in order to crunch a sprite, we have to
<b>disable</b> Y-expand at cycle&nbsp;15. To disable Y-expand, it must first be
enabled. But when we <b>don't</b> wish to crunch, we shouldn't enable Y-expand
in the first place, or we would end up with a line of graphics being displayed
twice. The upshot is that the dynamic information (stored in the pixels) must
indicate whether or not we have to enable Y-expand <b>in anticipation</b> of a
sprite crunch. Then, at cycle&nbsp;15, we simply turn off Y-expand for all
sprites.</p>

<p>Furthermore, recall that sprite pixels are fetched during the rasterline
preceeding the one on which they are displayed. So the data fetched during
line&nbsp;0 is displayed during line&nbsp;1, sampled as soon as possible
afterwards, namely early during line&nbsp;2, after which it is used to set up
the Y-expand register in anticipation of a line crunch on line&nbsp;3. Hence,
crunch operations are delayed, and have to be encoded in the sprite graphics
three rasterlines earlier than they are supposed to happen.</p>

<p>Such a delay is straightforward to bake into the pixels of a particular
sprite, but it becomes problematic around the seams since we want to support
switching between different crunch schedules. Critically, all the schedules
used in my effect start with the same four offsets:
35–38–3b–3e. Hence, as long as we update the sprite pointers
while displaying the data that was fetched from offset 0x35 or from the last
offset before wrapping around, everything will be fine.</p>

<p>There won't be enough time to update all eight sprite pointers on the same
rasterline. But as it turns out, we can arrange the code to allow updates
to sprites 0–4 on odd lines and sprites 5–7 on even lines. That is
why every sprite needs to have a row of blank pixels at offset 0x35: The
pointer update could be off by one line, but this won't result in a visual
artefact, because it is precisely the blank line that might get fetched from
the wrong location.</p>

<p>At this point, let's have a look at the actual code for a pair of
rasterlines. Note that sprite DMA takes away cycles&nbsp;55 through&nbsp;10,
although cycle&nbsp;55 is available for writing.</p>

<div class="otherbg">
<pre>;               Invariants: x = y = 0     Cycle

template
                nop                     ; 54 11

                sty     $d017           ; 12, crunch
                lda     $d01f           ; 16
                sta     $d017           ; 20
tem_s5
                lda     #$80            ; 24
                lda     vm+$3fd         ; 26
tem_s6
                lda     #$80            ; 30
                lda     vm+$3fe         ; 32
tem_s7
                lda     #$80            ; 36
                lda     vm+$3ff         ; 38

                nop                     ; 42
                nop                     ; 44
                nop                     ; 46
                nop                     ; 48
tem_rr
                lda     #$3e            ; 50
                sta     $d011           ; 52, repeat row

                shy     $d017,x         ; 11, crunch
                lda     $d01f           ; 16
                sta     $d017           ; 20
tem_s0
                lda     #$80            ; 24
                lda     vm+$3f8         ; 26
tem_s1
                lda     #$80            ; 30
                lda     vm+$3f9         ; 32
tem_s2
                lda     #$80            ; 36
                lda     vm+$3fa         ; 38
tem_s3
                lda     #$80            ; 42
                lda     vm+$3fb         ; 44
tem_s4
                lda     #$80            ; 48
                lda     vm+$3fc         ; 50
</pre>
</div>

<p>The above template is rolled out a hundred times, forming the bulk of the
rastercode for this effect.</p>

<p><tt>$80</tt> is a dummy value. During vertical blanking, sprite pointers are
written into these operands, and the subsequent <tt>lda</tt> instructions are
changed into <tt>sta</tt> instructions, writing the sprite pointers into the
proper locations. Before updating the rastercode for the next video frame, the
<tt>sta</tt> instructions are changed back into harmless <tt>lda</tt>
instructions.</p>

<p>The actual sprite crunch is triggered by clearing the Y-expand register
(<tt>$d017</tt>) at cycle&nbsp;15. The <tt>sty</tt> instruction takes four
cycles, the last one being the actual write cycle. The <tt>shy</tt> instruction
performs the same operation in five cycles (<tt>x</tt> and <tt>y</tt> are
zero). We write to <tt>$d011</tt> at cycle&nbsp;55 on every other line in order
to stave off badlines, which would otherwise mess up the timing completely. It
is possible to squeeze in the write to <tt>$d011</tt> right before sprite DMA,
but when we return we're already at cycle&nbsp;11, and since there are no
single-cycle instructions, we have to use a five-cycle instruction such as
<tt>shy</tt>.</p>

<p>Now, before we can jump into the above rastercode, we have to ensure that
each of the eight sprites is currently at the correct offset. The eight columns
of letters are scrolling smoothly and independently of each other, so these
offsets are going to be different on every frame, and offset&nbsp;0x35 isn't
even part of the normal sequence (where every offset is divisible by three).
This calls for a chunk of preliminary rastercode, just to get all the initial
sprite offsets right. What I ended up doing was to start all sprites at the
same Y&nbsp;coordinate somewhere in the upper border, and crunch them all at
offset&nbsp;0x2d (ending up at&nbsp;0x35). Then I start applying the MISC
technique as described, but for a given number of rasterlines (depending on the
smooth-scroll offset of each column) I override the value from the collision
register with a logic one, forcing a sprite crunch from offset&nbsp;0x35 back
to itself, effectively stretching the sprite. The bitmasks for overriding the
collision register are taken from a small table (22&nbsp;bytes) that is
calculated during the vertical blanking interval.</p>

<p>Every column is animated independently. There isn't enough time during
vertical blanking to rearrange the pointer updates in the rastercode for all
eight of them. In fact, only two or three columns move in each frame, although
in my opinion it still looks like a 50&nbsp;fps effect overall. What determines
whether two or three columns are updated? This actually depends on the music. I
animate two columns, call the music player, then read out the current raster
position to determine whether there's enough time to animate a third
column.</p>

<h2>Conclusion</h2>

<p>In this article, I have described how to implement Massively Interleaved
Sprite Crunch, a new demo effect for the C64. I hope you'll agree that state
of the art VIC trickery in 2016 is complicated, delightfully idiosyncratic,
even downright wacky—but perfectly explicable.</p>

<div style="clear: both"><p class="edited">Posted Monday 19-Dec-2016 22:22</p></div>
<div style="width: 100%; word-wrap: break-word; clear: both">
<h3 style="padding-top: 1em">Discuss this page</h3><p class="disclaimer">Disclaimer:
 I am not responsible for what people (other than myself) write in the 
forums. Please report any abuse, such as insults, slander, spam and 
illegal material, and I will take appropriate actions. Don't feed the 
trolls.</p><p class="disclaimer">Jag tar inget ansvar för det som skrivs
 i forumet, förutom mina egna inlägg. Vänligen rapportera alla inlägg 
som bryter mot reglerna, så ska jag se vad jag kan göra. Som regelbrott 
räknas till exempel förolämpningar, förtal, spam och olagligt material. 
Mata inte trålarna.</p><div class="forum0"><div class="forum1">Anonymous<br>Tue 20-Dec-2016 10:42</div><div class="forum2">Very clever, and thanks for the interesting read!<br><br>Greetings from Daniel (Pernod)</div><div class="forumpostbuttons"><div class="forumpostbutton"><form action="/forum/report.php" method="post"><div><input name="id" value="2193" type="hidden"><input name="swe" value="f" type="hidden"><input class="fbutton" name="quote" value="Report abuse" type="submit"></div></form></div><div class="forumpostbutton"><form action="/forum/write.php" method="post"><div><input name="pk" value="1" type="hidden"><input name="pg" value="148" type="hidden"><input name="import" value="2193" type="hidden"><input class="fbutton" name="quote" value="Quote &amp; reply" type="submit"></div></form></div></div></div>
<div class="forum0"><div class="forum1">Anonymous<br>Wed 21-Dec-2016 12:00</div><div class="forum2">Very
 interesting read! I wish there were more of such clear in-depth 
articles explaining these tricks. That's a clever and elegant solution 
to encode the crunch schedule into the sprite.<br><br>Btw, ((MC | 
MCBASE) &amp; 0x15) | ((MC &amp; MCBASE) &amp; 0x2a) can be simplified 
to (MC | MCBASE) &amp; 0x3f, can't it? Is it known what's happening in 
the hardware when this value is generated?</div><div class="forumpostbuttons"><div class="forumpostbutton"><form action="/forum/report.php" method="post"><div><input name="id" value="2194" type="hidden"><input name="swe" value="f" type="hidden"><input class="fbutton" name="quote" value="Report abuse" type="submit"></div></form></div><div class="forumpostbutton"><form action="/forum/write.php" method="post"><div><input name="pk" value="1" type="hidden"><input name="pg" value="148" type="hidden"><input name="import" value="2194" type="hidden"><input class="fbutton" name="quote" value="Quote &amp; reply" type="submit"></div></form></div></div></div>
<div class="forum0"><div class="forum1"><b>lft</b><br>Linus Åkesson<br>Wed 21-Dec-2016 13:30</div><div class="forum2"><div class="forumquote">Btw, ((MC | MCBASE) &amp; 0x15) | ((MC &amp; MCBASE) &amp; 0x2a) can be simplified to (MC | MCBASE) &amp; 0x3f, can't it?</div><br>No,
 the proposed simplification would compute bitwise-or between all the 
bits. The original expression computes bitwise-and for odd-numbered 
bits, bitwise-or for even-numbered bits.<br><br><div class="forumquote">Is it known what's happening in the hardware when this value is generated?</div><br>I
 have a pretty good guess: Every other bit is inverted in the internal 
representation. This is sometimes done when implementing registers that 
have to be incremented quickly, and MC does have to be incremented on 
three succesive half-cycles. So what *really* happens is a bitwise-and 
across the entire value, and this is a typical artefact of NMOS logic.</div><div class="forumpostbuttons"><div class="forumpostbutton"><form action="/forum/report.php" method="post"><div><input name="id" value="2195" type="hidden"><input name="swe" value="f" type="hidden"><input class="fbutton" name="quote" value="Report abuse" type="submit"></div></form></div><div class="forumpostbutton"><form action="/forum/write.php" method="post"><div><input name="pk" value="1" type="hidden"><input name="pg" value="148" type="hidden"><input name="import" value="2195" type="hidden"><input class="fbutton" name="quote" value="Quote &amp; reply" type="submit"></div></form></div></div></div>
<div class="forum0"><div class="forum1">Anonymous<br>Wed 21-Dec-2016 17:34</div><div class="forum2"><div class="forumquote"><p class="forumquote"><b>lft</b> wrote:</p><div class="forumquote">Btw, ((MC | MCBASE) &amp; 0x15) | ((MC &amp; MCBASE) &amp; 0x2a) can be simplified to (MC | MCBASE) &amp; 0x3f, can't it?</div><br>No,
 the proposed simplification would compute bitwise-or between all the 
bits. The original expression computes bitwise-and for odd-numbered 
bits, bitwise-or for even-numbered bits.</div><br>Oops, that was dumb. I
 read the article yesterday, but this morning I thought it was ((MC | 
MCBASE) &amp; 0x15) | ((MC | MCBASE) &amp; 0x2a), that is, MC | MCBASE 
twice. I should not post before morning coffee :-)</div><div class="forumpostbuttons"><div class="forumpostbutton"><form action="/forum/report.php" method="post"><div><input name="id" value="2196" type="hidden"><input name="swe" value="f" type="hidden"><input class="fbutton" name="quote" value="Report abuse" type="submit"></div></form></div><div class="forumpostbutton"><form action="/forum/write.php" method="post"><div><input name="pk" value="1" type="hidden"><input name="pg" value="148" type="hidden"><input name="import" value="2196" type="hidden"><input class="fbutton" name="quote" value="Quote &amp; reply" type="submit"></div></form></div></div></div>
<div class="forum0"><div class="forum1"><b>ralph</b><br>Ralph Corderoy<br>Wed 28-Dec-2016 20:27</div><div class="forum2"><div class="forumquote"><p class="forumquote"><b>lft</b> wrote:</p>Every
 other bit is inverted in the internal representation. This is sometimes
 done when implementing registers that have to be incremented quickly</div><br>Is this to speed the carry ripple?  Have you a name for this technique so I can Google, or a reference?</div><div class="forumpostbuttons"><div class="forumpostbutton"><form action="/forum/report.php" method="post"><div><input name="id" value="2200" type="hidden"><input name="swe" value="f" type="hidden"><input class="fbutton" name="quote" value="Report abuse" type="submit"></div></form></div><div class="forumpostbutton"><form action="/forum/write.php" method="post"><div><input name="pk" value="1" type="hidden"><input name="pg" value="148" type="hidden"><input name="import" value="2200" type="hidden"><input class="fbutton" name="quote" value="Quote &amp; reply" type="submit"></div></form></div></div></div>
<div class="forum0"><div class="forum1"><b>lft</b><br>Linus Åkesson<br>Thu  5-Jan-2017 16:18</div><div class="forum2"><div class="forumquote"><p class="forumquote"><b>ralph</b> wrote:</p><div class="forumquote"><p class="forumquote"><b>lft</b> wrote:</p>Every
 other bit is inverted in the internal representation. This is sometimes
 done when implementing registers that have to be incremented quickly</div><br>Is this to speed the carry ripple?  Have you a name for this technique so I can Google, or a reference?</div><br>I
 couldn't find anything that mentions counters in particular, but it's 
described for adders in general e.g. here, slides 10-11: 
http://www.cs.tufts.edu/comp/103/notes/Lecture13(Adders).pdf</div><div class="forumpostbuttons"><div class="forumpostbutton"><form action="/forum/report.php" method="post"><div><input name="id" value="2201" type="hidden"><input name="swe" value="f" type="hidden"><input class="fbutton" name="quote" value="Report abuse" type="submit"></div></form></div><div class="forumpostbutton"><form action="/forum/write.php" method="post"><div><input name="pk" value="1" type="hidden"><input name="pg" value="148" type="hidden"><input name="import" value="2201" type="hidden"><input class="fbutton" name="quote" value="Quote &amp; reply" type="submit"></div></form></div></div></div>
<div class="forum0"><div class="forum1">Anonymous<br>Fri  6-Jan-2017 21:38</div><div class="forum2">Very interesting explanation of a very clever technique. The demo itself is also a gem!<br><br>Greetings from Poland. <br><br>Krzysztof (Brush/Elysium)</div><div class="forumpostbuttons"><div class="forumpostbutton"><form action="/forum/report.php" method="post"><div><input name="id" value="2202" type="hidden"><input name="swe" value="f" type="hidden"><input class="fbutton" name="quote" value="Report abuse" type="submit"></div></form></div><div class="forumpostbutton"><form action="/forum/write.php" method="post"><div><input name="pk" value="1" type="hidden"><input name="pg" value="148" type="hidden"><input name="import" value="2202" type="hidden"><input class="fbutton" name="quote" value="Quote &amp; reply" type="submit"></div></form></div></div></div>
<div class="forum0"><div class="forum1">Anonymous<br>Tue  7-Mar-2017 03:03</div><div class="forum2">Hello, great explanation and fantastic demo! <br><br>If
 your crunched sprite starts at offset 0x35 what do you do to get there 
to begin with? Do you start at 0 with the FG color set to black or in 
the top border and do some dummy crunch to traverse the graph to the 
right starting point? <br><br>On another topic, it seems the demo can 
behave a bit weird with multiple disk drives present on the serial bus 
(tried with a real 1541 as drive 8 and an Ultimate-II as drive 9)... 
could it be that you implement some custom serial protocol which the 
other drive might respond to or something?</div><div class="forumpostbuttons"><div class="forumpostbutton"><form action="/forum/report.php" method="post"><div><input name="id" value="2224" type="hidden"><input name="swe" value="f" type="hidden"><input class="fbutton" name="quote" value="Report abuse" type="submit"></div></form></div><div class="forumpostbutton"><form action="/forum/write.php" method="post"><div><input name="pk" value="1" type="hidden"><input name="pg" value="148" type="hidden"><input name="import" value="2224" type="hidden"><input class="fbutton" name="quote" value="Quote &amp; reply" type="submit"></div></form></div></div></div>
<div class="forum0"><div class="forum1">Anonymous<br>Thu 15-Jun-2017 16:44</div><div class="forum2">I'm
 really a novice ... I almost understood  nothing with your 
disquisitions except some basic concept... I envy you deeply :) ... <br>Thanks guys for your passion and for you knowledge sharing !</div><div class="forumpostbuttons"><div class="forumpostbutton"><form action="/forum/report.php" method="post"><div><input name="id" value="2307" type="hidden"><input name="swe" value="f" type="hidden"><input class="fbutton" name="quote" value="Report abuse" type="submit"></div></form></div><div class="forumpostbutton"><form action="/forum/write.php" method="post"><div><input name="pk" value="1" type="hidden"><input name="pg" value="148" type="hidden"><input name="import" value="2307" type="hidden"><input class="fbutton" name="quote" value="Quote &amp; reply" type="submit"></div></form></div></div></div>
<div class="forum0"><div class="forum1">Anonymous<br>Fri  1-Dec-2017 05:03</div><div class="forum2"><div class="forumquote">If
 your crunched sprite starts at offset 0x35 what do you do to get there 
to begin with? Do you start at 0 with the FG color set to black or in 
the top border and do some dummy crunch to traverse the graph to the 
right starting point? </div><br>Was wondering that myself. I guess 
that's what he means. Im unsure of the benefit of this though, as 
opposed to simply changing the sprite definition pointer. The sprite 
hasnt ended, and loops back... so I guess you can change the def and 
effectively have the sprite "start again". It's still the same sprite 
though, as opposed to the 17 pixel sprites that are the minimum.<br><br><div class="forumquote">On
 another topic, it seems the demo can behave a bit weird with multiple 
disk drives present on the serial bus (tried with a real 1541 as drive 8
 and an Ultimate-II as drive 9)... could it be that you implement some 
custom serial protocol which the other drive might respond to or 
something?</div><br>Nearly all modern demo loaders have the same issue. 
They uses the various lines in weird ways, which means the ATTN line 
(from memory) is getting smashed and confusing other attached drives.<br><br>Could
 possibly be worth enumerating the attached drives at the start and 
putting all drives except #8 in a hard loop of some kind, but the easier
 solution is to just turn off all drives except #8 when watching a demo 
:)<br><br>StY1z000r</div><div class="forumpostbuttons"><div class="forumpostbutton"><form action="/forum/report.php" method="post"><div><input name="id" value="2356" type="hidden"><input name="swe" value="f" type="hidden"><input class="fbutton" name="quote" value="Report abuse" type="submit"></div></form></div><div class="forumpostbutton"><form action="/forum/write.php" method="post"><div><input name="pk" value="1" type="hidden"><input name="pg" value="148" type="hidden"><input name="import" value="2356" type="hidden"><input class="fbutton" name="quote" value="Quote &amp; reply" type="submit"></div></form></div></div></div>
<form method="get" action="/forum/write.php"><div><input name="pk" value="1" type="hidden"><input name="pg" value="148" type="hidden"><input class="button" value="Post a new comment" type="submit"></div></form></div>
</div></div></div></div></body></html>